#!/usr/bin/env ruby

require 'pathname'
require 'pp'
require 'yaml'
require 'json'
require 'fileutils'
require 'thread'

require 'cmds'

require 'qb'

require 'nrser/refinements'
using NRSER


DEBUG_ARGS = ['-D', '--DEBUG']


def set_debug! args
  if DEBUG_ARGS.any? {|arg| args.include? arg}
    QB::Util::Logging.setup level: :debug
    DEBUG_ARGS.each {|arg| args.delete arg}
  end
end


def main args
  Thread.current.name = 'main'
  logger = SemanticLogger['qb/exe/qb#main']
  
  set_debug! args
  logger.debug args: args
  
  QB.check_ansible_version
  
  logger.debug "Main switch arg" => args[0]
  
  method_name, method_args = case args[0]
  when nil, '-h', '--help', 'help'
    [:help, []]
  when 'play'
    [:play, args.rest]
  when 'run'
    [:run, args.rest]
  when 'setup'
    [:setup, args.rest]
  else
    # default to `run` on the full args
    [:run, args]
  end
  
  logger.debug "Calling QB::CLI.#{ method_name }",
    method_args: method_args
  
  status = begin
    QB::CLI.public_send method_name, method_args
  rescue Exception => error
    raise error
  end
  
  logger.debug "QB::CLI.#{ method_name } returned, exiting.", status: status
  exit status
end


main(ARGV) # if __FILE__ == $0 # doesn't work with gem stub or something?
